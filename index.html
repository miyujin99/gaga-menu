<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Team Food Order</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --brand:#f97316; --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb; --bg:#f8fafc; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); background:var(--bg); }
    header { position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--line); }
    .wrap { max-width:1100px; margin:auto; padding:18px; }
    h1 { font-size:clamp(20px, 3vw, 28px); margin:0; }
    .muted { color:var(--muted); }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:16px; }
    .card { background:#fff; border:1px solid var(--line); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; }
    .thumb { width:100%; aspect-ratio:4/3; object-fit:cover; background:#fff; }
    .card-body { padding:12px; display:flex; flex-direction:column; gap:8px; }
    .title { font-weight:600; }
    .price { color:#065f46; font-weight:600; font-size:14px; }
    .qty { display:flex; align-items:center; gap:6px; margin-top:auto; }
    .qty input { width:64px; padding:6px 8px; border:1px solid var(--line); border-radius:8px; text-align:center; font-weight:600; }
    .qty button { border:1px solid var(--line); background:#fff; border-radius:8px; width:32px; height:32px; font-weight:700; cursor:pointer; }
    .panel { background:#fff; border:1px solid var(--line); border-radius:14px; padding:12px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .row > * { margin: 4px 0; }
    input[type="text"] { padding:10px 12px; border:1px solid var(--line); border-radius:10px; min-width:260px; }
    .btn { appearance:none; border:none; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; }
    .btn-primary { background:var(--brand); color:#fff; }
    .btn-line { background:#fff; border:1px solid var(--line); }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-top:1px solid var(--line); padding:8px 10px; text-align:left; font-size:14px; }
    th { color:var(--muted); font-weight:600; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; }
    .footer { color:var(--muted); font-size:12px; margin-top:8px; }
    .hint { font-size:12px; color:var(--muted); }
    .totals { font-weight:700; }
    .empty { padding:6px 8px; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üçΩÔ∏è Team Food Order</h1>
      <div class="muted">Loads items from <code>assets/menu.csv</code></div>
    </div>
  </header>

  <main class="wrap" id="app">
    <!-- Controls -->
    <div class="panel" style="margin-bottom:16px">
      <div class="row">
        <label for="person"><strong>Your name</strong></label>
        <input id="person" type="text" placeholder="e.g., Alice Nguyen" />
        <button id="submitOrder" class="btn btn-primary">Save this selection</button>
        <span class="hint">Each person: enter name ‚Üí set quantities ‚Üí Save.</span>
      </div>
      <div class="row" style="margin-top:8px">
        <span class="pill" id="liveCount">üë• 0 people saved</span>
        <span class="pill" id="liveItems">üßæ 0 total items</span>
        <button id="dlDetailed" class="btn btn-line">Download detailed CSV (by person)</button>
        <button id="dlSummary" class="btn btn-line">Download summary CSV (item totals)</button>
        <button id="resetAll" class="btn btn-line" title="Clear everything (this page only)">Reset</button>
      </div>
    </div>

    <!-- Menu grid -->
    <div id="menuGrid" class="grid" aria-live="polite"></div>

    <!-- Live submissions -->
    <div class="panel" style="margin-top:16px">
      <h3 style="margin:0 0 8px 0">Recent submissions</h3>
      <div id="submissions"></div>
    </div>

    <!-- Item totals -->
    <div class="panel" style="margin-top:16px">
      <h3 style="margin:0 0 8px 0">Live item totals</h3>
      <div id="itemTotals"></div>
      <div class="footer">Totals update every time someone saves their selection.</div>
    </div>

    <div class="footer">
      Note: CSV files download to the user‚Äôs computer (browsers can‚Äôt write into your <code>assets/</code> folder).
    </div>
  </main>

  <script>
    // ---------- Utility: lightweight CSV parser (handles quoted commas) ----------
    function parseCSV(str) {
      const rows = [];
      let row = [], cell = '', inQuotes = false;
      for (let i=0; i<str.length; i++) {
        const c = str[i], n = str[i+1];
        if (c === '"' ) {
          if (inQuotes && n === '"') { cell += '"'; i++; }
          else { inQuotes = !inQuotes; }
        } else if (c === ',' && !inQuotes) {
          row.push(cell.trim()); cell = '';
        } else if ((c === '\n' || c === '\r') && !inQuotes) {
          if (cell.length || row.length) { row.push(cell.trim()); rows.push(row); row = []; cell=''; }
        } else {
          cell += c;
        }
      }
      if (cell.length || row.length) { row.push(cell.trim()); rows.push(row); }
      // header ‚Üí objects
      if (!rows.length) return [];
      const header = rows[0].map(h => h.toLowerCase().trim());
      const out = [];
      for (let i=1; i<rows.length; i++) {
        const r = rows[i]; if (r.length===1 && r[0]==='') continue;
        const obj = {};
        header.forEach((h, j) => obj[h] = (r[j] ?? '').trim());
        out.push(obj);
      }
      return out;
    }

    // ---------- Paths & image helpers ----------
    function slugify(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
    function imageFor(row){
      // Preferred: explicit "image" column (filename or path)
      let img = (row.image || row.photo || '').trim();
      if (img) {
        if (/^https?:\/\//i.test(img) || img.startsWith('assets/')) return img;
        return 'assets/images/' + img;
      }
      // Fallback: assets/images/<slug>.jpg, else pizza.jpg
      const guess = 'assets/images/' + slugify(row.name || row.item || '') + '.jpg';
      return guess;
    }
    function priceOf(row){
      const raw = row.price || row.cost || '';
      if (!raw) return '';
      const num = Number(String(raw).replace(/[^0-9.\-]/g,''));
      if (Number.isFinite(num)) return num.toFixed(num % 1 ? 2 : 0);
      return raw;
    }

    // ---------- State ----------
    let MENU = []; // [{name, price, ...}]
    const CART = new Map(); // key: itemName ‚Üí qty (current user before Save)
    const SUBMISSIONS = []; // [{person, items:[{item, qty, price}], at: Date}]

    // ---------- DOM refs ----------
    const menuGrid = document.getElementById('menuGrid');
    const submissionsDiv = document.getElementById('submissions');
    const itemTotalsDiv = document.getElementById('itemTotals');
    const personInput = document.getElementById('person');
    const liveCount = document.getElementById('liveCount');
    const liveItems = document.getElementById('liveItems');
    const btnSave = document.getElementById('submitOrder');
    const btnDlDetailed = document.getElementById('dlDetailed');
    const btnDlSummary = document.getElementById('dlSummary');
    const btnReset = document.getElementById('resetAll');

    // ---------- Renderers ----------
    function renderMenu() {
      if (!MENU.length) {
        menuGrid.innerHTML = '<div class="empty">No items found. Check <code>assets/menu.csv</code>.</div>';
        return;
      }
      menuGrid.innerHTML = '';
      for (const row of MENU) {
        const name = row.name || row.item || '(Unnamed item)';
        const price = priceOf(row);
        const imgSrc = imageFor(row);

        const card = document.createElement('div');
        card.className = 'card';

        const img = document.createElement('img');
        img.className = 'thumb';
        img.src = imgSrc;
        img.alt = name;
        img.onerror = () => { img.onerror=null; img.src='assets/images/pizza.jpg'; };

        const body = document.createElement('div');
        body.className = 'card-body';

        const t = document.createElement('div');
        t.className = 'title';
        t.textContent = name;

        const p = document.createElement('div');
        p.className = 'price';
        p.textContent = price ? `$${price}` : '';

        const qty = document.createElement('div');
        qty.className = 'qty';

        const minus = document.createElement('button'); minus.type='button'; minus.textContent='‚àí';
        const input = document.createElement('input'); input.type='number'; input.min='0'; input.step='1'; input.value = CART.get(name) || 0;
        const plus = document.createElement('button'); plus.type='button'; plus.textContent='+';

        const setQty = (val) => {
          const n = Math.max(0, Math.floor(Number(val)||0));
          input.value = n;
          if (n>0) CART.set(name, n); else CART.delete(name);
          updateLiveTotals();
        };
        minus.addEventListener('click', () => setQty(Number(input.value)-1));
        plus.addEventListener('click', () => setQty(Number(input.value)+1));
        input.addEventListener('input', () => setQty(input.value));

        qty.append(minus, input, plus);
        body.append(t, p, qty);
        card.append(img, body);
        menuGrid.append(card);
      }
    }

    function renderSubmissions() {
      if (!SUBMISSIONS.length) {
        submissionsDiv.innerHTML = '<div class="empty">No submissions yet.</div>';
        return;
      }
      let html = '<table><thead><tr><th>Person</th><th>Items</th><th>When</th></tr></thead><tbody>';
      for (const s of SUBMISSIONS.slice().reverse()) {
        const itemsTxt = s.items.map(x => `${x.item} √ó${x.qty}`).join(', ');
        html += `<tr><td>${escapeHtml(s.person)}</td><td>${escapeHtml(itemsTxt)}</td><td>${new Date(s.at).toLocaleString()}</td></tr>`;
      }
      html += '</tbody></table>';
      submissionsDiv.innerHTML = html;
    }

    function renderItemTotals() {
      const totals = computeItemTotals();
      if (!Object.keys(totals).length) {
        itemTotalsDiv.innerHTML = '<div class="empty">No items yet.</div>';
        return;
      }
      let grand = 0;
      let html = '<table><thead><tr><th>Item</th><th>Qty</th><th>Total $</th></tr></thead><tbody>';
      for (const [item, info] of Object.entries(totals)) {
        const sum = (info.totalPrice ?? 0);
        grand += sum;
        html += `<tr><td>${escapeHtml(item)}</td><td>${info.qty}</td><td>$${sum.toFixed(2)}</td></tr>`;
      }
      html += `<tr class="totals"><td>Total</td><td></td><td>$${grand.toFixed(2)}</td></tr>`;
      html += '</tbody></table>';
      itemTotalsDiv.innerHTML = html;
    }

    function updateLiveTotals(){
      const people = SUBMISSIONS.length;
      const items = Object.values(computeItemTotals()).reduce((a,b)=>a+b.qty,0);
      liveCount.textContent = `üë• ${people} ${people===1?'person':'people'} saved`;
      liveItems.textContent = `üßæ ${items} total items`;
    }

    // ---------- Data helpers ----------
    function computeItemTotals(){
      const map = {}; // name ‚Üí {qty, price}
      for (const s of SUBMISSIONS) {
        for (const it of s.items) {
          if (!map[it.item]) map[it.item] = { qty:0, price: it.price ?? null };
          map[it.item].qty += it.qty;
          if (it.price != null) map[it.item].price = it.price;
        }
      }
      // compute totals
      for (const [k,v] of Object.entries(map)) {
        const price = Number(v.price ?? 0);
        v.totalPrice = price ? (v.qty * price) : 0;
      }
      return map;
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

    function toCSV(rows){
      const quote = v => {
        const s = String(v ?? '');
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      };
      return rows.map(r => r.map(quote).join(',')).join('\n');
    }

    function downloadCSV(filename, rows){
      const csv = toCSV(rows);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(a.href);
    }

    // ---------- Events ----------
    btnSave.addEventListener('click', () => {
      const person = personInput.value.trim();
      if (!person) { alert('Please enter your name.'); return; }
      if (CART.size === 0) { alert('Please choose at least one item (qty > 0).'); return; }
      // build items list from CART based on MENU pricing
      const priceMap = new Map(MENU.map(r => [ (r.name||r.item||'').trim(), Number(priceOf(r) || 0) ]));
      const items = [];
      CART.forEach((qty, itemName) => {
        if (qty>0) items.push({ item:itemName, qty, price: priceMap.get(itemName) || null });
      });
      SUBMISSIONS.push({ person, items, at: new Date().toISOString() });
      // clear cart for next person
      CART.clear();
      personInput.value = '';
      renderMenu();
      renderSubmissions();
      renderItemTotals();
      updateLiveTotals();
    });

    btnDlDetailed.addEventListener('click', () => {
      if (!SUBMISSIONS.length) { alert('No submissions to export.'); return; }
      const rows = [['person','item','qty','price','timestamp']];
      for (const s of SUBMISSIONS) {
        for (const it of s.items) {
          rows.push([s.person, it.item, it.qty, it.price ?? '', s.at]);
        }
      }
      downloadCSV(`orders_detailed_${dateStamp()}.csv`, rows);
    });

    btnDlSummary.addEventListener('click', () => {
      const totals = computeItemTotals();
      const names = Object.keys(totals);
      if (!names.length){ alert('No items to summarize.'); return; }
      const rows = [['item','total_qty','unit_price','total_amount']];
      for (const name of names) {
        const t = totals[name];
        rows.push([name, t.qty, (t.price ?? ''), (t.totalPrice ?? 0).toFixed(2)]);
      }
      downloadCSV(`orders_summary_${dateStamp()}.csv`, rows);
    });

    btnReset.addEventListener('click', () => {
      if (!confirm('Clear all in-page data (cart + submissions)?')) return;
      CART.clear(); SUBMISSIONS.length = 0; personInput.value = '';
      renderMenu(); renderSubmissions(); renderItemTotals(); updateLiveTotals();
    });

    function dateStamp(){
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
    }

    // ---------- Boot ----------
    (async function init(){
      try {
        const res = await fetch('assets/menu.csv', { cache: 'no-store' });
        if (!res.ok) throw new Error('Failed to load assets/menu.csv');
        const text = await res.text();
        const rows = parseCSV(text);

        // Normalize expected columns
        // Expect at least: name (or item). Optional: price, category, image.
        // Example header: name,price,image
        MENU = rows.map(r => {
          const obj = Object.assign({}, r);
          // Normalize key casing fallback already handled by parser; just ensure "name"
          obj.name = r.name || r.item || '';
          return obj;
        }).filter(r => r.name);

        renderMenu();
        renderSubmissions();
        renderItemTotals();
        updateLiveTotals();
      } catch (e) {
        console.error(e);
        menuGrid.innerHTML = '<div class="panel">Could not load <code>assets/menu.csv</code>. Check the file path and that you‚Äôre running this page via a local server (not from a file:// URL).</div>';
      }
    })();
  </script>
</body>
</html>
